<section xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{fragments/admin-layout}" layout:fragment="body">

    <body>
        <div class="container py-4">
            <h2 class="text-center mb-4 fw-bold text-primary">üìä B√°o c√°o th·ªëng k√™</h2>

            <!-- B·ªô l·ªçc ng√†y -->
            <form id="filterForm" class="row g-3 align-items-end mb-5 fade-in">
                <div class="col-md-4">
                    <label for="fromDate" class="form-label fw-semibold">T·ª´ ng√†y</label>
                    <input type="date" id="fromDate" name="fromDate" class="form-control border-primary" required>
                    <div class="invalid-feedback" id="fromDateError"></div>
                </div>
                <div class="col-md-4">
                    <label for="toDate" class="form-label fw-semibold">ƒê·∫øn ng√†y</label>
                    <input type="date" id="toDate" name="toDate" class="form-control border-primary" required>
                    <div class="invalid-feedback" id="toDateError"></div>
                </div>
                <div class="col-md-4">
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary flex-fill" id="filterBtn">
                            <i class="bi bi-funnel-fill me-2"></i>L·ªçc
                        </button>
                        <button type="button" class="btn btn-outline-secondary flex-fill" id="resetBtn">
                            <i class="bi bi-arrow-clockwise me-2"></i>L√†m m·ªõi
                        </button>
                    </div>
                </div>
            </form>

            <!-- Th√¥ng b√°o l·ªói -->
            <div class="alert alert-danger d-none" id="errorAlert" role="alert">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                <span id="errorMessage"></span>
            </div>

            <!-- Th√¥ng tin kho·∫£ng th·ªùi gian -->
            <div class="alert alert-info d-none" id="dateRangeInfo" role="alert">
                <i class="bi bi-calendar-range me-2"></i>
                <span id="dateRangeText"></span>
            </div>

            <!-- Loading spinner -->
            <div class="text-center d-none" id="loadingSpinner">
                <div class="loading-spinner">
                    <div class="spinner-ring"></div>
                    <div class="spinner-ring"></div>
                    <div class="spinner-ring"></div>
                </div>
                <p class="mt-3 text-muted fw-semibold loading-text">ƒêang t·∫£i d·ªØ li·ªáu th·ªëng k√™...</p>
                <div class="mt-2">
                    <div class="shimmer rounded" style="height: 20px; width: 200px; margin: 0 auto;"></div>
                </div>
            </div>

            <!-- T·ªïng quan -->
            <div class="row text-center mb-5" id="overviewSection">
                <div class="col-md-4">
                    <div class="card shadow-sm border-start border-success border-4 rounded-4 stat-card fade-in" style="animation-delay: 0.1s;">
                        <div class="card-body">
                            <h5 class="text-muted"><i class="bi bi-box-seam me-2 text-success"></i>S·∫£n ph·∫©m ƒë√£ b√°n</h5>
                            <strong class="fs-3 text-dark" id="totalProducts">0</strong>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card shadow-sm border-start border-primary border-4 rounded-4 stat-card fade-in" style="animation-delay: 0.2s;">
                        <div class="card-body">
                            <h5 class="text-muted"><i class="bi bi-currency-dollar me-2 text-primary"></i>T·ªïng doanh thu
                            </h5>
                            <strong class="fs-3 text-dark" id="totalRevenue">$0</strong>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card shadow-sm border-start border-warning border-4 rounded-4 stat-card fade-in" style="animation-delay: 0.3s;">
                        <div class="card-body">
                            <h5 class="text-muted"><i class="bi bi-people-fill me-2 text-warning"></i>Kh√°ch h√†ng</h5>
                            <strong class="fs-3 text-dark" id="totalCustomers">0</strong>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bi·ªÉu ƒë·ªì -->
            <div class="row mb-5" id="chartSection">
                <div class="col-md-6">
                    <div class="card shadow-sm border-start border-success border-3 rounded-4 fade-in" style="animation-delay: 0.4s;">
                        <div class="card-body">
                            <h5 class="text-center fw-semibold mb-3">üìà Doanh thu theo th√°ng</h5>
                            <div class="chart-container" id="revenueChartContainer">
                                <canvas id="revenueChart" style="max-height: 280px;"></canvas>
                            </div>
                            <div class="text-center text-muted d-none" id="noRevenueData">
                                <i class="bi bi-graph-down fs-1"></i>
                                <p>Kh√¥ng c√≥ d·ªØ li·ªáu doanh thu trong kho·∫£ng th·ªùi gian n√†y</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card shadow-sm border-start border-info border-3 rounded-4 fade-in" style="animation-delay: 0.5s;">
                        <div class="card-body">
                            <h5 class="text-center fw-semibold mb-3">üìä S·∫£n ph·∫©m b√°n theo danh m·ª•c</h5>
                            <div class="chart-container" id="categoryChartContainer">
                                <canvas id="categoryChart" style="max-height: 280px;"></canvas>
                            </div>
                            <div class="text-center text-muted d-none" id="noCategoryData">
                                <i class="bi bi-pie-chart fs-1"></i>
                                <p>Kh√¥ng c√≥ d·ªØ li·ªáu s·∫£n ph·∫©m trong kho·∫£ng th·ªùi gian n√†y</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Danh s√°ch kh√°ch h√†ng -->
            <div class="mb-5" id="customerSection">
                <h5 class="text-center mb-3 fw-bold text-secondary slide-in">üìã Danh s√°ch kh√°ch h√†ng mua h√†ng</h5>
                <div class="table-responsive" style="max-height: 300px;">
                    <table class="table table-hover align-middle text-center table-bordered border-secondary-subtle">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th>H·ªç t√™n</th>
                                <th>Email</th>
                                <th>S·ªë ƒë∆°n h√†ng</th>
                                <th>T·ªïng chi ti√™u</th>
                            </tr>
                        </thead>
                        <tbody id="customerTableBody">
                            <!-- Dynamic rows -->
                        </tbody>
                    </table>
                </div>
                <div class="text-center text-muted d-none" id="noCustomerData">
                    <i class="bi bi-people fs-1"></i>
                    <p>Kh√¥ng c√≥ d·ªØ li·ªáu kh√°ch h√†ng trong kho·∫£ng th·ªùi gian n√†y</p>
                </div>
            </div>

            <!-- Danh s√°ch s·∫£n ph·∫©m -->
            <div class="mb-5" id="productSection">
                <h5 class="text-center mb-3 fw-bold text-secondary slide-in">üõí Danh s√°ch s·∫£n ph·∫©m ƒë√£ b√°n</h5>
                <div class="table-responsive" style="max-height: 300px;">
                    <table class="table table-hover align-middle text-center table-bordered border-secondary-subtle">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th>T√™n s·∫£n ph·∫©m</th>
                                <th>Danh m·ª•c</th>
                                <th>S·ªë l∆∞·ª£ng b√°n</th>
                                <th>T·ªïng doanh thu</th>
                            </tr>
                        </thead>
                        <tbody id="productTableBody">
                            <!-- Dynamic rows -->
                        </tbody>
                    </table>
                </div>
                <div class="text-center text-muted d-none" id="noProductData">
                    <i class="bi bi-box-seam fs-1"></i>
                    <p>Kh√¥ng c√≥ d·ªØ li·ªáu s·∫£n ph·∫©m trong kho·∫£ng th·ªùi gian n√†y</p>
                </div>
            </div>
        </div>

        <style>
            /* Hi·ªáu ·ª©ng loading spinner ƒë·∫πp */
            .loading-spinner {
                position: relative;
                width: 60px;
                height: 60px;
                margin: 0 auto;
            }
            
            .loading-spinner .spinner-ring {
                position: absolute;
                width: 100%;
                height: 100%;
                border: 4px solid transparent;
                border-top: 4px solid #007bff;
                border-radius: 50%;
                animation: spin 1s linear infinite;
            }
            
            .loading-spinner .spinner-ring:nth-child(2) {
                border-top-color: #28a745;
                animation-delay: 0.2s;
            }
            
            .loading-spinner .spinner-ring:nth-child(3) {
                border-top-color: #ffc107;
                animation-delay: 0.4s;
            }
            
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }

            /* Hi·ªáu ·ª©ng fade in cho c√°c card */
            .fade-in {
                animation: fadeIn 0.8s ease-in-out;
            }
            
            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(30px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            /* Hi·ªáu ·ª©ng slide in cho b·∫£ng */
            .slide-in {
                animation: slideIn 0.6s ease-out;
            }
            
            @keyframes slideIn {
                from {
                    opacity: 0;
                    transform: translateX(-50px);
                }
                to {
                    opacity: 1;
                    transform: translateX(0);
                }
            }

            /* Hi·ªáu ·ª©ng pulse cho s·ªë li·ªáu */
            .pulse-number {
                animation: pulse 0.6s ease-in-out;
            }
            
            @keyframes pulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.1); }
                100% { transform: scale(1); }
            }

            /* Hi·ªáu ·ª©ng hover cho card */
            .stat-card {
                transition: all 0.3s ease;
                cursor: pointer;
            }
            
            .stat-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 25px rgba(0,0,0,0.15) !important;
            }

            /* Hi·ªáu ·ª©ng shimmer cho loading */
            .shimmer {
                background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
                background-size: 200% 100%;
                animation: shimmer 1.5s infinite;
            }
            
            @keyframes shimmer {
                0% { background-position: -200% 0; }
                100% { background-position: 200% 0; }
            }

            /* Hi·ªáu ·ª©ng cho bi·ªÉu ƒë·ªì */
            .chart-container {
                opacity: 0;
                transform: scale(0.9);
                transition: all 0.8s ease;
            }
            
            .chart-container.loaded {
                opacity: 1;
                transform: scale(1);
            }

            /* Hi·ªáu ·ª©ng cho b·∫£ng */
            .table-row {
                opacity: 0;
                transform: translateY(20px);
                animation: tableRowFadeIn 0.5s ease forwards;
            }
            
            @keyframes tableRowFadeIn {
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            /* Hi·ªáu ·ª©ng cho alert */
            .alert {
                animation: slideDown 0.4s ease-out;
            }
            
            @keyframes slideDown {
                from {
                    opacity: 0;
                    transform: translateY(-20px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            /* Hi·ªáu ·ª©ng cho form */
            .form-control:focus {
                transform: scale(1.02);
                transition: transform 0.2s ease;
            }

            /* Hi·ªáu ·ª©ng cho button */
            .btn {
                transition: all 0.3s ease;
                position: relative;
                overflow: hidden;
            }
            
            .btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            }
            
            .btn:active {
                transform: translateY(0);
            }

            /* Hi·ªáu ·ª©ng ripple cho button */
            .btn::after {
                content: '';
                position: absolute;
                top: 50%;
                left: 50%;
                width: 0;
                height: 0;
                border-radius: 50%;
                background: rgba(255,255,255,0.3);
                transform: translate(-50%, -50%);
                transition: width 0.6s, height 0.6s;
            }
            
            .btn:active::after {
                width: 300px;
                height: 300px;
            }

            /* Hi·ªáu ·ª©ng cho card khi load */
            .card {
                transition: all 0.3s ease;
            }

            /* Hi·ªáu ·ª©ng cho icon */
            .bi {
                transition: transform 0.3s ease;
            }

            .stat-card:hover .bi {
                transform: scale(1.2);
            }

            /* Hi·ªáu ·ª©ng cho table */
            .table tbody tr {
                transition: all 0.2s ease;
            }

            .table tbody tr:hover {
                background-color: rgba(0,123,255,0.1) !important;
                transform: scale(1.01);
            }

            /* Hi·ªáu ·ª©ng cho loading text */
            .loading-text {
                background: linear-gradient(45deg, #007bff, #28a745, #ffc107, #dc3545);
                background-size: 400% 400%;
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                animation: gradientShift 3s ease infinite;
            }

            @keyframes gradientShift {
                0% { background-position: 0% 50%; }
                50% { background-position: 100% 50%; }
                100% { background-position: 0% 50%; }
            }

            /* Hi·ªáu ·ª©ng cho chart container */
            .chart-container {
                position: relative;
            }

            .chart-container::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
                transform: translateX(-100%);
                transition: transform 0.6s ease;
            }

            .chart-container.loaded::before {
                transform: translateX(100%);
            }
        </style>
        <script>
            // Bi·∫øn ƒë·ªÉ l∆∞u tr·ªØ c√°c bi·ªÉu ƒë·ªì
            let revenueChart = null;
            let categoryChart = null;

            // H√†m hi·ªÉn th·ªã/·∫©n loading
            function showLoading(show) {
                const loading = document.getElementById('loadingSpinner');
                const overview = document.getElementById('overviewSection');
                const charts = document.getElementById('chartSection');
                const customers = document.getElementById('customerSection');
                const products = document.getElementById('productSection');
                
                if (show) {
                    loading.classList.remove('d-none');
                    overview.classList.add('d-none');
                    charts.classList.add('d-none');
                    customers.classList.add('d-none');
                    products.classList.add('d-none');
                } else {
                    loading.classList.add('d-none');
                    overview.classList.remove('d-none');
                    charts.classList.remove('d-none');
                    customers.classList.remove('d-none');
                    products.classList.remove('d-none');
                }
            }

            // H√†m hi·ªÉn th·ªã/·∫©n th√¥ng b√°o l·ªói
            function showError(message, show = true) {
                const errorAlert = document.getElementById('errorAlert');
                const errorMessage = document.getElementById('errorMessage');
                
                if (show) {
                    errorMessage.textContent = message;
                    errorAlert.classList.remove('d-none');
                } else {
                    errorAlert.classList.add('d-none');
                }
            }

            // H√†m hi·ªÉn th·ªã th√¥ng tin kho·∫£ng th·ªùi gian
            function showDateRangeInfo(fromDate, toDate, show = true) {
                const dateRangeInfo = document.getElementById('dateRangeInfo');
                const dateRangeText = document.getElementById('dateRangeText');
                
                if (show && fromDate && toDate) {
                    const from = new Date(fromDate).toLocaleDateString('vi-VN');
                    const to = new Date(toDate).toLocaleDateString('vi-VN');
                    dateRangeText.textContent = `ƒêang hi·ªÉn th·ªã th·ªëng k√™ t·ª´ ${from} ƒë·∫øn ${to}`;
                    dateRangeInfo.classList.remove('d-none');
                } else {
                    dateRangeInfo.classList.add('d-none');
                }
            }

            // H√†m validation ng√†y
            function validateDates(fromDate, toDate) {
                if (!fromDate || !toDate) {
                    showError('Vui l√≤ng ch·ªçn c·∫£ ng√†y b·∫Øt ƒë·∫ßu v√† ng√†y k·∫øt th√∫c');
                    return false;
                }

                const from = new Date(fromDate);
                const to = new Date(toDate);
                const today = new Date();

                if (from > to) {
                    showError('Ng√†y b·∫Øt ƒë·∫ßu kh√¥ng th·ªÉ l·ªõn h∆°n ng√†y k·∫øt th√∫c');
                    return false;
                }

                if (to > today) {
                    showError('Ng√†y k·∫øt th√∫c kh√¥ng th·ªÉ l·ªõn h∆°n ng√†y hi·ªán t·∫°i');
                    return false;
                }

                showError('', false);
                return true;
            }

            // H√†m x√≥a bi·ªÉu ƒë·ªì c≈©
            function destroyCharts() {
                if (revenueChart) {
                    revenueChart.destroy();
                    revenueChart = null;
                }
                if (categoryChart) {
                    categoryChart.destroy();
                    categoryChart = null;
                }
            }

            // H√†m hi·ªÉn th·ªã/·∫©n c√°c ph·∫ßn d·ªØ li·ªáu
            function toggleDataSections(hasData) {
                const noRevenueData = document.getElementById('noRevenueData');
                const noCategoryData = document.getElementById('noCategoryData');
                const noCustomerData = document.getElementById('noCustomerData');
                const noProductData = document.getElementById('noProductData');

                if (hasData) {
                    noRevenueData.classList.add('d-none');
                    noCategoryData.classList.add('d-none');
                    noCustomerData.classList.add('d-none');
                    noProductData.classList.add('d-none');
                } else {
                    noRevenueData.classList.remove('d-none');
                    noCategoryData.classList.remove('d-none');
                    noCustomerData.classList.remove('d-none');
                    noProductData.classList.remove('d-none');
                }
            }

            // H√†m t·∫°o hi·ªáu ·ª©ng cho s·ªë li·ªáu
            function animateNumber(element, finalValue, duration = 1000) {
                const startValue = 0;
                const startTime = performance.now();
                
                function updateNumber(currentTime) {
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    
                    // Easing function ƒë·ªÉ t·∫°o hi·ªáu ·ª©ng m∆∞·ª£t m√†
                    const easeOutQuart = 1 - Math.pow(1 - progress, 4);
                    const currentValue = startValue + (finalValue - startValue) * easeOutQuart;
                    
                    if (element.id === 'totalRevenue') {
                        element.textContent = Number(currentValue).toLocaleString('en-Us') + ' $';
                    } else {
                        element.textContent = Math.round(currentValue);
                    }
                    
                    if (progress < 1) {
                        requestAnimationFrame(updateNumber);
                    } else {
                        // Th√™m hi·ªáu ·ª©ng pulse khi ho√†n th√†nh
                        element.classList.add('pulse-number');
                        setTimeout(() => element.classList.remove('pulse-number'), 600);
                    }
                }
                
                requestAnimationFrame(updateNumber);
            }

            // H√†m t·∫°o hi·ªáu ·ª©ng cho b·∫£ng
            function animateTableRows(tableBody, rows) {
                rows.forEach((row, index) => {
                    row.style.animationDelay = `${index * 0.1}s`;
                    row.classList.add('table-row');
                });
            }

            async function loadReport(fromDate = '', toDate = '') {
                try {
                    showLoading(true);
                    showError('', false);
                    showDateRangeInfo(fromDate, toDate, fromDate && toDate);

                    let url = `/admin/reports/sales-report`;
                    if (fromDate && toDate) {
                        url += `?fromDate=${fromDate}&toDate=${toDate}`;
                    }

                    const response = await fetch(url);
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();

                    // Ki·ªÉm tra xem c√≥ d·ªØ li·ªáu hay kh√¥ng
                    const hasData = data.totalProductsSold > 0 || data.totalRevenue > 0 || data.totalCustomers > 0;
                    toggleDataSections(hasData);

                    // T·ªïng quan v·ªõi hi·ªáu ·ª©ng animation
                    animateNumber(document.getElementById('totalProducts'), data.totalProductsSold || 0);
                    animateNumber(document.getElementById('totalRevenue'), data.totalRevenue || 0);
                    animateNumber(document.getElementById('totalCustomers'), data.totalCustomers || 0);

                    // X√≥a bi·ªÉu ƒë·ªì c≈©
                    destroyCharts();

                    // Bi·ªÉu ƒë·ªì doanh thu (c·ªôt)
                    if (data.salesOverTime && data.salesOverTime.length > 0) {
                        const monthLabels = data.salesOverTime.map(e => `${e.month}/${e.year}`);
                        const revenues = data.salesOverTime.map(e => e.revenue);

                        revenueChart = new Chart(document.getElementById('revenueChart'), {
                            type: 'bar',
                            data: {
                                labels: monthLabels,
                                datasets: [{
                                    label: 'Doanh thu ($)',
                                    data: revenues,
                                    backgroundColor: '#42a5f5'
                                }]
                            },
                            options: {
                                responsive: true,
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        ticks: {
                                            callback: val => val.toLocaleString('en-Us') + '$'
                                        }
                                    }
                                }
                            }
                        });
                        
                        // Hi·ªáu ·ª©ng cho bi·ªÉu ƒë·ªì
                        setTimeout(() => {
                            document.getElementById('revenueChartContainer').classList.add('loaded');
                        }, 100);
                    }

                    // Bi·ªÉu ƒë·ªì s·∫£n ph·∫©m theo danh m·ª•c (tr√≤n)
                    if (data.salesByCategory && Object.keys(data.salesByCategory).length > 0) {
                        const categories = Object.keys(data.salesByCategory);
                        const values = Object.values(data.salesByCategory);

                        categoryChart = new Chart(document.getElementById('categoryChart'), {
                            type: 'pie',
                            data: {
                                labels: categories,
                                datasets: [{
                                    data: values,
                                    backgroundColor: ['#66bb6a', '#ffa726', '#42a5f5', '#ab47bc', '#ef5350', '#26a69a', '#ff7043', '#8d6e63']
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: {
                                        position: 'bottom'
                                    }
                                }
                            }
                        });
                        
                        // Hi·ªáu ·ª©ng cho bi·ªÉu ƒë·ªì
                        setTimeout(() => {
                            document.getElementById('categoryChartContainer').classList.add('loaded');
                        }, 200);
                    }

                    // B·∫£ng kh√°ch h√†ng
                    const customerBody = document.getElementById("customerTableBody");
                    customerBody.innerHTML = "";
                    if (data.customerDetails && data.customerDetails.length > 0) {
                        data.customerDetails.forEach(c => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${c.name || 'N/A'}</td>
                                <td>${c.email || 'N/A'}</td>
                                <td>${c.orderCount || 0}</td>
                                <td>${Number(c.totalSpent || 0).toLocaleString('en-Us')}$</td>
                            `;
                            customerBody.appendChild(row);
                        });
                        
                        // Hi·ªáu ·ª©ng cho c√°c d√≤ng b·∫£ng
                        const rows = customerBody.querySelectorAll('tr');
                        animateTableRows(customerBody, rows);
                    }

                    // B·∫£ng s·∫£n ph·∫©m
                    const productBody = document.getElementById("productTableBody");
                    productBody.innerHTML = "";
                    if (data.productDetails && data.productDetails.length > 0) {
                        data.productDetails.forEach(p => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${p.productName || 'N/A'}</td>
                                <td>${p.category || 'N/A'}</td>
                                <td>${p.quantitySold || 0}</td>
                                <td>${Number(p.totalRevenue || 0).toLocaleString('en-Us')}$</td>
                            `;
                            productBody.appendChild(row);
                        });
                        
                        // Hi·ªáu ·ª©ng cho c√°c d√≤ng b·∫£ng
                        const rows = productBody.querySelectorAll('tr');
                        animateTableRows(productBody, rows);
                    }

                    // Hi·ªÉn th·ªã th√¥ng b√°o n·∫øu kh√¥ng c√≥ d·ªØ li·ªáu
                    if (!hasData && fromDate && toDate) {
                        showError('Kh√¥ng c√≥ d·ªØ li·ªáu th·ªëng k√™ trong kho·∫£ng th·ªùi gian ƒë√£ ch·ªçn. Vui l√≤ng th·ª≠ kho·∫£ng th·ªùi gian kh√°c.', true);
                    } else if (!hasData) {
                        showError('Kh√¥ng c√≥ d·ªØ li·ªáu th·ªëng k√™ n√†o trong h·ªá th·ªëng.', true);
                    }

                } catch (err) {
                    console.error("L·ªói khi t·∫£i d·ªØ li·ªáu b√°o c√°o:", err);
                    showError(err.message || 'C√≥ l·ªói x·∫£y ra khi t·∫£i d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i sau.');
                    toggleDataSections(false);
                } finally {
                    showLoading(false);
                }
            }

            // H√†m reset form
            function resetForm() {
                document.getElementById('fromDate').value = '';
                document.getElementById('toDate').value = '';
                showError('', false);
                showDateRangeInfo('', '', false);
                loadReport(); // T·∫£i d·ªØ li·ªáu m·∫∑c ƒë·ªãnh
            }

            document.addEventListener("DOMContentLoaded", () => {
                // T·∫£i d·ªØ li·ªáu m·∫∑c ƒë·ªãnh khi trang ƒë∆∞·ª£c load
                loadReport();

                // X·ª≠ l√Ω form filter
                document.getElementById('filterForm').addEventListener('submit', function (e) {
                    e.preventDefault();
                    const from = document.getElementById('fromDate').value;
                    const to = document.getElementById('toDate').value;
                    
                    if (validateDates(from, to)) {
                        loadReport(from, to);
                    }
                });

                // X·ª≠ l√Ω n√∫t reset
                document.getElementById('resetBtn').addEventListener('click', resetForm);

                // Validation real-time cho ng√†y
                document.getElementById('fromDate').addEventListener('change', function() {
                    const from = this.value;
                    const to = document.getElementById('toDate').value;
                    if (from && to) {
                        validateDates(from, to);
                    }
                });

                document.getElementById('toDate').addEventListener('change', function() {
                    const from = document.getElementById('fromDate').value;
                    const to = this.value;
                    if (from && to) {
                        validateDates(from, to);
                    }
                });
            });
        </script>
    </body>
</section>